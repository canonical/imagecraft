name: ubuntu-server-amd64
version: "24.04.20241217"
base: bare
build-base: ubuntu@24.04
platforms:
  amd64:

parts:
  rootfs:
    plugin: nil
    overlay-script: |
      mmdebstrap --arch amd64 --mode=sudo --format=dir --variant=minbase --include=apt noble $CRAFT_OVERLAY/ http://archive.ubuntu.com/ubuntu/
    stage:
      - -*
  bootloader:
    plugin: nil
    after: [rootfs]
    overlay-script: |
      # mkdir -p $CRAFT_OVERLAY/dev $CRAFT_OVERLAY/sys $CRAFT_OVERLAY/proc
      mount -t devtmpfs devtmpfs-build $CRAFT_OVERLAY/dev
      mount -t devpts devpts-build -o nodev,nosuid $CRAFT_OVERLAY/dev/pts
      mount -t sysfs sysfs-build $CRAFT_OVERLAY/sys
      mount -t proc proc-build $CRAFT_OVERLAY/proc
      mount --bind /run $CRAFT_OVERLAY/run
      mkdir -p $CRAFT_OVERLAY/boot/efi
      # mount $CRAFT_PART_INSTALL $CRAFT_OVERLAY/boot
      chroot $CRAFT_OVERLAY lsblk
      chroot $CRAFT_OVERLAY apt update
      DEBIAN_FRONTEND=noninteractive chroot $CRAFT_OVERLAY apt install --assume-yes --quiet --option=Dpkg::options::=--force-unsafe-io --option=Dpkg::Options::=--force-confold grub-pc shim-signed
      chroot $CRAFT_OVERLAY ls /boot
      chroot $CRAFT_OVERLAY grub-install --boot-directory=/boot --efi-directory=/boot/efi --target=x86_64-efi --uefi-secure-boot --no-nvram
      mount --make-rprivate $CRAFT_OVERLAY/run
      umount --recursive $CRAFT_OVERLAY/run
      mount --make-rprivate $CRAFT_OVERLAY/sys
      umount --recursive $CRAFT_OVERLAY/sys
      mount --make-rprivate $CRAFT_OVERLAY/proc
      umount --recursive $CRAFT_OVERLAY/proc
      mount --make-rprivate $CRAFT_OVERLAY/dev/pts
      umount --recursive $CRAFT_OVERLAY/dev/pts
      mount --make-rprivate $CRAFT_OVERLAY/dev
      umount --recursive $CRAFT_OVERLAY/dev
    organize:
      '/boot/efi/': (efi)/boot/efi/


volumes:
  pc:
    bootloader: grub
    schema: gpt
    structure:
      - name: boot
        type: 21686148-6449-6E6F-744E-656564454649
        size: 1000000
        offset: 1000000
        role: system-boot
        content:
          - source: (bios)/pc-core.img
            target: (bios)/pc-core.img
      - name: EFI
        type: C12A7328-F81F-11D2-BA4B-00A0C93EC93B
        filesystem: vfat
        filesystem-label: system-boot
        size: 256000000
        role: system-boot
        content:
          - source: (efi)/
            target: /
      - name: rootfs
        type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4
        filesystem: ext4
        filesystem-label: writable
        role: system-data
        size: 3000000000
        content:
          - source: /rootfs
            target: /
