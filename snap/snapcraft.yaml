name: imagecraft
base: core24
summary: Imagecraft is a craft tool used to create Ubuntu bootable images.
description: |
  Imagecraft is a craft tool used to create Ubuntu bootable images. It follows
  the same principles as snapcraft, but is focused on creating bootable images
  instead.
adopt-info: imagecraft
confinement: classic
grade: devel
license: GPL-3.0
source-code: https://github.com/canonical/imagecraft

platforms:
  amd64:
  arm64:
  armhf:
  riscv64:
  s390x:
  ppc64el:

apps:
  imagecraft:
    command: bin/python3 $SNAP/bin/imagecraft
    environment:
      PATH: "$SNAP/libexec/imagecraft:/snap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      PERL5LIB: $SNAP/usr/share/perl5:$SNAP/usr/share/perl:$PERL5LIB
    completer: completion.sh

build-packages:
  - git
  - libapt-pkg-dev
  - libyaml-dev
  - libxml2-dev
  - libxslt1-dev
  - python3.12-dev
  - python3.12-venv
  - pkg-config
  - python3-pip
  - python3-setuptools
  - python3-wheel
  - python3-venv
  - python3-minimal
  - python3-pkg-resources
  - python3.12-minimal

parts:
  imagecraft-libs:
    plugin: nil
    build-attributes:
      - enable-patchelf
    stage-packages:
      - apt
      - apt-transport-https
      - apt-utils
      - gpgv
      - libgit2-1.7
      - libpython3-stdlib
      - libpython3.12-stdlib
      - libpython3.12-minimal
      - libxml2
      - libxslt1.1
      - python-apt-common
      - python3-apt
      - python3-pip
      - python3-setuptools
      - python3-wheel
      - python3-pkg-resources
      - python3.12-venv
      - python3.12-minimal
      - python3-minimal
      - mtools
      - dosfstools
      - e2fsprogs
      - fdisk
      - coreutils
      - util-linux
    stage:
      - "-usr/lib/x86_64-linux-gnu/libicuio.so.*"
      - "-usr/lib/x86_64-linux-gnu/libicutest.so.*"
      - "-usr/lib/x86_64-linux-gnu/libicutu.so.*"
      - "-usr/lib/x86_64-linux-gnu/libicui18n.so.*"
    organize:
      "usr/lib/python3/dist-packages/apt*": "lib/python3.12/site-packages/"
      "usr/sbin/sfdisk": "libexec/imagecraft/sfdisk"
      "usr/bin/mcopy": "libexec/imagecraft/mcopy"
      "usr/bin/mtools": "libexec/imagecraft/mtools"
      "usr/bin/dd": "libexec/imagecraft/dd"
      "usr/bin/truncate": "libexec/imagecraft/truncate"
      "usr/sbin/mkfs*": "libexec/imagecraft/"
  # Build our own version of fuse-overlayfs due to https://github.com/containers/fuse-overlayfs/issues/429
  # The apt and Launchpad repositories as of 23/07/25 do not have a sufficiently new version to get this patch
  fuse-overlayfs:
    source: https://github.com/containers/fuse-overlayfs.git
    source-tag: v1.15
    plugin: autotools
    build-attributes:
      - enable-patchelf
    build-packages:
      - libfuse3-dev
      - pkgconf
    stage-packages:
      - libfuse3-3
    organize:
      "usr/local/bin/fuse-overlayfs": "libexec/imagecraft/fuse-overlayfs"
  imagecraft:
    after: [imagecraft-libs]
    source: .
    plugin: uv
    build-attributes:
      - enable-patchelf
    build-packages:
      - libffi-dev
      - libgit2-dev
      - cargo-1.85
      - pkg-config
      - git
    build-snaps:
      - astral-uv
    build-environment:
      - "CFLAGS": "$(pkg-config python-3.12 yaml-0.1 libgit2 --cflags)"
      - UV_COMPILE_BYTECODE: "1"
      - UV_NO_BINARY: "1"
      - MAKEOPTS: -j$(nproc --all)
      - CARGO: cargo-1.85
      - RUSTC: rustc-1.85
    organize:
      bin/craftctl: libexec/imagecraft/craftctl
    override-build: |
      ${SNAP}/libexec/snapcraft/craftctl default
      sed -i -e '1 s|^#!/.*|#!/snap/imagecraft/current/bin/python -E|' $CRAFT_PART_INSTALL/bin/craftctl
      version="$(PYTHONPATH=$CRAFT_PART_INSTALL/lib/python3.12/site-packages "${CRAFT_STAGE}/usr/bin/python3" -c "import imagecraft;print(imagecraft.__version__)")"
      ${SNAP}/libexec/snapcraft/craftctl set version="$version"

      rm $CRAFT_PART_INSTALL/bin/python*
      ln -s ../usr/bin/python3 $CRAFT_PART_INSTALL/bin/python3
      ln -s python3 $CRAFT_PART_INSTALL/bin/python

  bash-completion:
    after: [imagecraft]
    plugin: nil
    build-environment:
      - PYTHONPATH: $CRAFT_STAGE/lib/python3.12/site-packages
    override-build: |
      python3 -m craft_cli.completion $CRAFT_PROJECT_NAME imagecraft.cli:get_app_info \
        > $CRAFT_PART_INSTALL/completion.sh
