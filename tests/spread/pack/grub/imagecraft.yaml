name: minimal-with-grub
version: "0.1"
base: bare
build-base: ubuntu@24.04

platforms:
  amd64:

filesystems:
  default:
    - mount: /
      device: (volume/pc/rootfs)
    - mount: /boot/efi/
      device: (volume/pc/efi)

parts:
  # build a simple rootfs
  rootfs:
    plugin: nil
    build-packages: ["mmdebstrap"]
    overlay-script: |
      mmdebstrap --arch amd64 --mode=sudo --format=dir --variant=minbase --include=apt noble $CRAFT_OVERLAY/ http://archive.ubuntu.com/ubuntu/
      mkdir $CRAFT_OVERLAY/boot/efi

  # add packages
  packages:
    plugin: nil
    overlay-packages:
      - ubuntu-server-minimal
      - grub2-common
      - grub-pc
      - shim-signed
      - linux-image-generic

  # Define a fstab
  fstab:
    plugin: nil
    after: [packages]
    overlay-script: |
      cat << EOF > $CRAFT_OVERLAY/etc/fstab
      LABEL=writable	/	ext4	discard,errors=remount-ro	0	1
      LABEL=UEFI	/boot/efi	vfat	umask=0077	0 1
      EOF

volumes:
  pc:
    schema: gpt
    structure:
      - name: efi
        type: C12A7328-F81F-11D2-BA4B-00A0C93EC93B
        filesystem: vfat
        role: system-boot
        filesystem-label: EFI System
        size: 256M
      - name: rootfs
        type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4
        filesystem: ext4
        filesystem-label: writable
        role: system-data
        size: 5G
