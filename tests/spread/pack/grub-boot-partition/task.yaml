summary: Pack an image with GRUB and a dedicated boot partition

systems: [ubuntu-24.04-64]

execute: |
  GRUB_INSTALL_LOG="Setting up GRUB in the image"

  imagecraft pack --verbosity verbose --destructive-mode 2>&1 >/dev/null | MATCH "$GRUB_INSTALL_LOG"

  # Check that the message was actually written to the logfile.
  imagecraft_log_file=$(find /root/.local/state/imagecraft/log/ -name 'imagecraft*.log' | sort -n | tail -n1)
  MATCH "$GRUB_INSTALL_LOG" "$imagecraft_log_file"
  # Also check detailed of the installation were logged
  MATCH "Generating grub configuration file" "$imagecraft_log_file"
  MATCH "Adding boot menu entry for UEFI Firmware Settings" "$imagecraft_log_file"

restore: |
  imagecraft clean --destructive-mode
  rm -rf pc.img || true

debug: |
  df -h
  du -h -d 1 /tmp/
  mount -l
